# Confidential Document Manager Application

This application demo is a confidential document web application. This service enables users to upload and download documents and ensures that the documents are always encrypted. Users can create accounts. We use a simple password-based authentication. For production, one should add a two-factor authentication. The application  consists of the following components:

- a **Python FastAPI** service serving as the application's REST API,
- a **MariaDB** service stores the documents and user authentication data,
- a **memcached** service, serving as a rate limiter for the application, and
- an **nginx** instance serves as a proxy server for the application, ensuring termination and forwarding with TLS.

![scone mesh](architecture.png)

All of these components run securely inside of enclaves using the SCONE framework. These services are also integrity protected, and attest each other transparently using TLS in conjunction with a SCONE Configuration and Attestation Service (CAS). Furthermore, the application protects the confidentiality and integrity of all data it receives. We deploy this application using `helm`.

## Building und Running the Application

No time to read all the steps? We put the sconectl and helm steps in script `run.sh`. Just execute `./run.sh` and have a happy sconification!

![scone mesh](scone_gen_app_image.png)

You can get this program to run with the following steps.

### Make sure that your local machine meet all requirements

1. Export APP_IMAGE_REPO to point to some registry you have read and write access permissions.

```bash
export APP_IMAGE_REPO=example.registry.com
```

2. Export the `sconectl` repo. For this tutorial, set it to `registry.scontain.com/cicd`

```bash
export SCONECTL_REPO=registry.scontain.com/cicd
```

3. Run the `check_prerequisites.sh` script. It will check things like the SCONE CRDs in your K8s cluster and your access to the SCONE registry.

```bash
./check_prerequisites.sh
```

### Sconify the FastAPI service and the Client Service with `sconectl` `genservice` kind

1. Create `service.yaml` using the `service.yaml.template` template. This YAML will describe your confidential FastAPI service. Do the same thing with the `clientService.yaml.template` template to create the `clientService.yaml` describing the client.

```bash
SCONE="\$SCONE" envsubst < service.yaml.template > service.yaml
SCONE="\$SCONE" envsubst < clientService.yaml.template > clientService.yaml
```

2. Run `sconectl` with `service.yaml` and `clientService.yaml` to create the confidential services (also known as SCONE elements in the context of SCONE meshes).

```
sconectl apply -f service.yaml
sconectl apply -f clientService.yaml
```

3. Get the information about the CAS deployed in your K8s cluster using the SCONE plugin for `kubectl`. Check if `$CAS_SERVICE` and `$CAS_NAMESPACE` are not empty. If these variables are empty after the following commands, then your CAS is not healthy and you cannot continue. The CAS installation needs to be fixed in this case.

```bash
export CAS_SERVICE=`kubectl get cas --all-namespaces | grep HEALTHY | awk '{print $2}'`
export CAS_NAMESPACE=`kubectl get cas --all-namespaces | grep HEALTHY | awk '{print $1}'`
source <(kubectl provision cas $CAS_SERVICE -n $CAS_NAMESPACE --print-public-keys)
```

4. Create a meshfile using the `mesh.yaml.template` file. This `mesh.yaml` will describe the SCONE mesh that deploys the SecureDocumentApp application with all of its confidential components.

```bash
export RELEASE=secure-doc-management
export APP_NAMESPACE="$RELEASE-$RANDOM-$RANDOM"
SCONE="\$SCONE" envsubst < mesh.yaml.template > mesh.yaml
```

5. Use `sconectl` again to create the SCONE mesh. The following command will upload the security policies for the SecureDocumentApp. It also creates the Helm chart that we use to deploy the application. Besides that, define the release name for the Helm installation.

```bash
sconectl apply -f mesh.yaml --release "$RELEASE"
```

6. Deploy the app with the Helm chart generated by `sconectl`.

```bash
helm install "$RELEASE" target/helm/
```

## Cleaning up resources

You can uninstall the application with the following command:

```bash
helm uninstall "$RELEASE"
```